
**Выполнил: Радионов Никита Дмитриевич БПИ236**

| Метод  | Endpoint            | Описание                                    |
| ------ | ------------------- | ------------------------------------------- |
| `POST` | `/accounts`         | Создать счёт для пользователя               |
| `POST` | `/accounts/deposit` | Пополнить счёт                              |
| `GET`  | `/accounts/balance` | Получить баланс пользователя                |
| `POST` | `/orders`           | Создать заказ (асинхронно запускает оплату) |
| `GET`  | `/orders`           | Получить список заказов пользователя        |
| `GET`  | `/orders/{id}`      | Получить конкретный заказ (с его статусом)  |

#### Архитектура

1. API Gateway – отвечает только за routing запросов
2. Order Service – отвечает за создание заказа, просмотра списка заказов и просмотра статуса заказа
3. Payments Service – отвечает за создание, пополнение и просмотра баланса счета.

#### Фоновый обмен сообщениями между OrderService и PaymentsService

Реализованы паттерны Transactional Outbox и Inbox для взаимодействия микросервисов OrderService и PaymentsService с гарантией доставки сообщений и предотвращением их дублирования

##### 1. Создание заказа и Transactional Outbox в OrderService

- При создании заказа (`CreateOrderAsync`) внутри одной транзакции базы данных создаётся:
	
	- Запись заказа в таблицу `Orders`.
		
	- Запись события (OutboxMessage) в таблицу `OutboxMessages` — с данными о новом заказе, сериализованными в JSON.
		
- Транзакция коммитится только после успешного добавления обеих записей. Это гарантирует атомарность — либо заказ и событие создаются вместе, либо не создаются вовсе.
	
- Фоновый сервис `OutboxProcessorService` периодически опрашивает таблицу `OutboxMessages` на предмет новых или неотправленных сообщений.
	
- Для каждого найденного сообщения сервис отправляет его в очередь RabbitMQ (`orders`) и после успешной отправки помечает сообщение как обработанное (Processed).
    

##### 2. Приём и обработка сообщений в PaymentsService (Inbox)

- Сервис `OrderMessageConsumer` подписан на очередь `orders` RabbitMQ и получает сообщения о созданных заказах.
	
- Для каждого сообщения создаётся запись в таблице `InboxMessages`, если сообщения с таким MessageId ещё не существует. Это предотвращает повторную обработку одного и того же сообщения (идемпотентность).
	
- Далее фоновой задачей `InboxProcessorService` выбираются необработанные сообщения из `InboxMessages`.
	
- Каждое сообщение обрабатывается в отдельной транзакции:
	
	- Десериализуется запрос на оплату.
		
	- Проверяется баланс пользователя с блокировкой записи с помощью SQL `FOR UPDATE` для предотвращения гонок.
		
	- Если средств достаточно, происходит списание баланса.
		
	- Результат обработки упаковывается в событие `PaymentResultDto` и записывается в таблицу `OutboxMessages` PaymentsService.
		
- Сообщение из `InboxMessages` помечается как обработанное (Processed).
    

##### 3. Отправка статуса оплаты из PaymentsService в OrderService (Transactional Outbox)
	
- Фоновый сервис `OutboxPublisherService` в PaymentsService периодически опрашивает таблицу `OutboxMessages` на предмет новых сообщений о статусе оплаты.
	
- Для каждого такого сообщения отправляется событие в очередь RabbitMQ `payment_status`.
	
- После успешной отправки сообщение помечается как отправленное (`Sent`).
    

##### 4. Обработка статуса оплаты в OrderService

- Сервис `PaymentStatusConsumerService` подписан на очередь `payment_status` и получает уведомления о результате оплаты заказа.
	    
- Полученный статус обновляет соответствующий заказ в базе OrderService:
	    
	- `success` — заказ помечается как `FINISHED`.
	        
	- Любой другой статус — заказ помечается как `CANCELLED`.
	        
- После успешной обработки сообщение подтверждается (ack) в RabbitMQ.

#### Архитектурная схема

```less
[Client] --> [API Gateway] --> [OrdersService (PostgreSQL + Outbox)]
                                   |
                            RabbitMQ (orders, payment_status)
                                   |
                             [PaymentsService (PostgreSQL + Inbox)]

```


#### Для запуска проекта:

```bash
git clone https://github.com/NikitaRadionov/BigHW3.git
cd BigHW3
docker-compose up -d
```

Swagger UI:

- `http://localhost:8080/swagger` — API Gateway

Пользователь взаимодействует только со всем через API Gateway, прямого доступа к остальным двум микросервисам нет.
